name: Test Bundle Helpers

on:
  push:
    tags:
    - '*'
    branches:
    - master
    - release-*
  pull_request:
    types:
    - opened
    - reopened
    - synchronize

env:
 RELATED_IMAGE_MAIN: foo
 RELATED_IMAGE_SCANNER: foo
 RELATED_IMAGE_SCANNER_SLIM: foo
 RELATED_IMAGE_SCANNER_DB: foo
 RELATED_IMAGE_SCANNER_DB_SLIM: foo
 RELATED_IMAGE_COLLECTOR: foo
 RELATED_IMAGE_ROXCTL: foo
 RELATED_IMAGE_CENTRAL_DB: foo
 RELATED_IMAGE_SCANNER_V4_DB: foo
 RELATED_IMAGE_SCANNER_V4: foo

jobs:
  test-python-implementation:
    strategy:
      matrix:
        related_img_mode:
        - konflux
        - omit
        - downstream
    name: Test Python Implementation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: operator

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r bundle_helpers/requirements.txt

      - name: Run Python unit tests
        run: make test-bundle-helpers

      - name: Generate bundle with Python
        env:
          USE_GO_BUNDLE_HELPER: false
          RELATED_IMAGES_MODE: ${{ matrix.related_img_mode }}
        run: |
          set -euo pipefail
          go mod tidy
          make bundle bundle-post-process
          mkdir -p /tmp/artifacts
          cp -r bundle /tmp/artifacts/bundle-python
          if [ -d build/bundle ]; then
            cp -r build/bundle /tmp/artifacts/build-bundle-python
          fi
          git diff || true

      - name: Upload Python bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-python-${{ matrix.related_img_mode }}
          path: /tmp/artifacts/
          retention-days: 1

  test-go-implementation:
    strategy:
      fail-fast: false
      matrix:
        related_img_mode:
        - konflux
        - omit
        - downstream
    name: Test Go Implementation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: operator

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run Go unit tests
        run: |
          cd bundle_helpers
          go test ./...

      # For python fallback
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # For python fallback
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r bundle_helpers/requirements.txt

      - name: Generate bundle with Go
        env:
          USE_GO_BUNDLE_HELPER: true
          RELATED_IMAGES_MODE: ${{ matrix.related_img_mode }}
        run: |
          set -euo pipefail
          go mod tidy
          make bundle bundle-post-process
          mkdir -p /tmp/artifacts
          cp -r bundle /tmp/artifacts/bundle-go
          if [ -d build/bundle ]; then
            cp -r build/bundle /tmp/artifacts/build-bundle-go
          fi
          git diff || true

      - name: Upload Go bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-go-${{ matrix.related_img_mode }}
          path: /tmp/artifacts/
          retention-days: 1

  compare-implementations:
    strategy:
      fail-fast: false
      matrix:
        related_img_mode:
        - konflux
        - omit
        - downstream
    name: Compare Python and Go Outputs
    runs-on: ubuntu-latest
    needs: [test-python-implementation, test-go-implementation]
    # Only run comparison if Go implementation exists
    if: always() && needs.test-go-implementation.result == 'success'

    steps:
      - name: Download Python bundle
        uses: actions/download-artifact@v4
        with:
          name: bundle-python-${{ matrix.related_img_mode }}
          path: /tmp/python

      - name: Download Go bundle
        uses: actions/download-artifact@v4
        with:
          name: bundle-go-${{ matrix.related_img_mode }}
          path: /tmp/go
        continue-on-error: true

      - name: Install comparison tools
        run: |
          sudo apt-get update
          sudo apt-get install -y diffutils

      - name: Compare bundle outputs
        run: |
          echo "=== Comparing Python and Go bundle outputs ==="

          if diff -ruN /tmp/python/bundle-python /tmp/go/bundle-go; then
            echo "✓ SUCCESS: Bundle outputs are identical"
          else
            echo "✗ FAILURE: Bundle outputs differ"
            exit 1
          fi
          echo ""
          echo "=== Pruning createdAt lines..."
          sed -i '/^    createdAt:/d' /tmp/*/build-bundle-*/manifests/rhacs-operator.clusterserviceversion.yaml

          echo ""
          echo "=== Comparing build/bundle outputs ==="
          if diff -ruN /tmp/python/build-bundle-python /tmp/go/build-bundle-go; then
            echo "✓ SUCCESS: Build bundle outputs are identical"
          else
            echo "✗ FAILURE: Build bundle outputs differ"
            exit 1
          fi
          echo ""
          echo "=== Listing contents"
          find /tmp/python /tmp/go -ls
          find /tmp/python /tmp/go -type f -print0 | xargs -0 md5sum | sort

  status-check:
    strategy:
      matrix:
        related_img_mode:
        - konflux
        - omit
        - downstream
    name: Bundle Helper Tests Status
    runs-on: ubuntu-latest
    needs: [test-python-implementation, test-go-implementation, compare-implementations]
    if: always()

    steps:
      - name: Check test results
        run: |
          python_result="${{ needs.test-python-implementation.result }}"
          go_result="${{ needs.test-go-implementation.result }}"
          compare_result="${{ needs.compare-implementations.result }}"

          echo "Python tests: $python_result"
          echo "Go tests: $go_result"
          echo "Comparison: $compare_result"

          if [ "$python_result" != "success" ]; then
            echo "✗ Python tests failed"
            exit 1
          fi

          if [ "$go_result" != "success" ]; then
            echo "✗ Go tests failed"
            exit 1
          fi

          if [ "$compare_result" != "success" ]; then
            echo "✗ Go/Python comparison failed"
            exit 1
          fi

          echo "✓ All required tests passed"
